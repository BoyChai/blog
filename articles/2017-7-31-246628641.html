
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>int16溢出bug记录 - Chyroc的博客</title>
<meta property="og:title" content="blog.chyroc.cn" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Chyroc的博客" />
<meta property="og:description" content="Chyroc的博客" />
<link rel="canonical" href="blog.chyroc.cn" />
<meta property="og:url" content="blog.chyroc.cn" />
<meta property="og:site_name" content="blog.chyroc.cn" />
<script type="application/ld+json">
{"name":"blog.chyroc.cn","description":"Chyroc的博客","author":"Chyroc","@type":"WebSite","url":"blog.chyroc.cn","image":null,"publisher":null,"headline":"blog.chyroc.cn","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>


<link href="https://blog.chyroc.cn/assets/css/style.css" rel="stylesheet">
</head>
<body>
<div class="container-lg px-3 my-5 markdown-body">

<h1>
<a id="user-content-int16溢出bug记录" class="anchor" href="#int16%E6%BA%A2%E5%87%BAbug%E8%AE%B0%E5%BD%95" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>int16溢出bug记录</h1>
<p>在一个业务中用到了token</p>
<p>加密：将各种信息+生成时间(issueTime)+有效期(ttl)利用私钥加密，然后base64。</p>
<p>判断过期的时候，会首先去检查token里面编码的 <code>issueTime+ttl</code>，和<code>time.now</code>对比。</p>
<p>但是呢，为了减少token的长度，<code>ttl</code>是int16类型的（单位分钟），所以最大存储 32768。而我们需要存储一星期的token，也就是 7<em>24</em>60 = 10080。</p>
<p>哈哈，本来是没有问题的，bug就是出现在下面一点。</p>
<p>计算过期：</p>
<div class="highlight highlight-source-go"><pre><span class="pl-k">if</span> issueTime + <span class="pl-c1">uint32</span>(ttl*<span class="pl-c1">60</span>) &lt; time.<span class="pl-c1">Now</span>().<span class="pl-c1">Unix</span>() {
    <span class="pl-c"><span class="pl-c">//</span> 过期</span>
}</pre></div>
<p>我刚开始是认为ttl虽然是int16的，但是外面包了一层uint32，所以结果没什么问题。可是<code>ttl*60</code>的结果直接就溢出了，所以就算外面包了一层，也没有任何影响。最终的结果还是溢出。。</p>
<p>改进：</p>
<div class="highlight highlight-source-go"><pre><span class="pl-k">if</span> issueTime + <span class="pl-c1">uint32</span>(ttl)*<span class="pl-c1">60</span> &lt; time.<span class="pl-c1">Now</span>().<span class="pl-c1">Unix</span>() {
    <span class="pl-c"><span class="pl-c">//</span> 过期</span>
}</pre></div>
<p>bug记录。</p>


</div>

</body>
</html>
