
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>异步与函数引用外部变量的问题 - chyroc的博客</title>
<meta property="og:title" content="blog.chyroc.cn" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="chyroc的博客" />
<meta property="og:description" content="chyroc的博客" />
<link rel="canonical" href="blog.chyroc.cn" />
<meta property="og:url" content="blog.chyroc.cn" />
<meta property="og:site_name" content="blog.chyroc.cn" />
<script type="application/ld+json">
{"name":"blog.chyroc.cn","description":"chyroc的博客","author":"chyroc","@type":"WebSite","url":"blog.chyroc.cn","image":null,"publisher":null,"headline":"blog.chyroc.cn","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>


<link href="http://blog.chyroc.cn/assets/css/style.css?v=305ca492b034089b2a2287dae4e9fa13ac15b666" rel="stylesheet">
</head>
<body>
<div class="container-lg px-3 my-5 markdown-body">

<p>原因就是因为是异步的，循环会首先执行结束，再去执行函数</p>
<p>如果循环次数比较少的话，那么函数所引用的外部变量就会变成最后一个值，在函数<code>f1</code>中，就是全部是<code>c</code></p>
<p>所以可以想象的是，如果循环特别多的话，那么会有一部分函数引用的变量是一样的，结果就是输出很多个x，再输出很多个x+1...，如函数<code>f3</code></p>
<p>解决这个问题的方法就是，不要在函数内部直接引用外部变量，而是显式的传递参数，如函数<code>f2</code></p>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s"><span class="pl-pds">"</span>fmt<span class="pl-pds">"</span></span>
	<span class="pl-s"><span class="pl-pds">"</span>sync<span class="pl-pds">"</span></span>
)

<span class="pl-k">func</span> <span class="pl-en">f1</span>() {
	<span class="pl-smi">wg</span> <span class="pl-k">:=</span> sync.<span class="pl-smi">WaitGroup</span>{}
	wg.<span class="pl-c1">Add</span>(<span class="pl-c1">3</span>)

	<span class="pl-smi">s</span> <span class="pl-k">:=</span> []<span class="pl-k">string</span>{<span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>c<span class="pl-pds">"</span></span>}
	<span class="pl-k">for</span> <span class="pl-smi">_</span>, <span class="pl-smi">i</span> <span class="pl-k">:=</span> <span class="pl-k">range</span> s {
		<span class="pl-k">go</span> <span class="pl-k">func</span>() {
			fmt.<span class="pl-c1">Printf</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i) <span class="pl-c"><span class="pl-c">//</span> &lt;--- 打印的都是c，也就是打印了3个c</span>
			wg.<span class="pl-c1">Done</span>()
		}()
	}

	wg.<span class="pl-c1">Wait</span>()
}

<span class="pl-k">func</span> <span class="pl-en">f2</span>() {
	<span class="pl-smi">wg</span> <span class="pl-k">:=</span> sync.<span class="pl-smi">WaitGroup</span>{}
	wg.<span class="pl-c1">Add</span>(<span class="pl-c1">3</span>)

	<span class="pl-smi">s</span> <span class="pl-k">:=</span> []<span class="pl-k">string</span>{<span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>c<span class="pl-pds">"</span></span>}
	<span class="pl-k">for</span> <span class="pl-smi">_</span>, <span class="pl-smi">i</span> <span class="pl-k">:=</span> <span class="pl-k">range</span> s {
		<span class="pl-k">go</span> <span class="pl-k">func</span>(t <span class="pl-k">string</span>) {
			fmt.<span class="pl-c1">Printf</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, t) <span class="pl-c"><span class="pl-c">//</span> &lt;--- a, b, c</span>
			wg.<span class="pl-c1">Done</span>()
		}(i)
	}

	wg.<span class="pl-c1">Wait</span>()
}

<span class="pl-k">func</span> <span class="pl-en">f3</span>() {
	<span class="pl-smi">wg</span> <span class="pl-k">:=</span> sync.<span class="pl-smi">WaitGroup</span>{}

	<span class="pl-smi">i</span> <span class="pl-k">:=</span> <span class="pl-c1">0</span>

	<span class="pl-k">for</span> {
		i++
		wg.<span class="pl-c1">Add</span>(<span class="pl-c1">1</span>)
		<span class="pl-k">go</span> <span class="pl-k">func</span>() {
			fmt.<span class="pl-c1">Printf</span>(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, i) <span class="pl-c"><span class="pl-c">//</span> &lt;--- 连续打印几个相同的数字，然后跳跃继续</span>
			wg.<span class="pl-c1">Done</span>()
		}()
	}

	wg.<span class="pl-c1">Wait</span>()
}</pre></div>


<script src="http://blog.chyroc.cn/assets/javascript/anchor-js/anchor.min.js"></script>
<script>anchors.add();</script>

<div id="disqus_thread"></div>
<script>
(function () { 
var d = document, s = d.createElement('script')
s.src = 'https://chyroc.disqus.com/embed.js'
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s)
})()
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
Disqus.</a></noscript>
<script id="dsq-count-scr" src="//chyroc.disqus.com/count.js" async></script>

</div>

</body>
</html>
