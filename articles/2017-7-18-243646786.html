
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>看一看mongo的ObjectId - Chyroc的博客</title>
<meta property="og:title" content="blog.chyroc.cn" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Chyroc的博客" />
<meta property="og:description" content="Chyroc的博客" />
<link rel="canonical" href="blog.chyroc.cn" />
<meta property="og:url" content="blog.chyroc.cn" />
<meta property="og:site_name" content="blog.chyroc.cn" />
<script type="application/ld+json">
{"name":"blog.chyroc.cn","description":"Chyroc的博客","author":"Chyroc","@type":"WebSite","url":"blog.chyroc.cn","image":null,"publisher":null,"headline":"blog.chyroc.cn","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>


<link href="http://blog.chyroc.cn/assets/css/style.css" rel="stylesheet">
</head>
<body>
<div class="container-lg px-3 my-5 markdown-body">

<h1>
<a id="user-content-mongodb-的-objectid" class="anchor" href="#mongodb-%E7%9A%84-objectid" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>mongodb 的 ObjectId</h1>
<h2>
<a id="user-content-官方文档解释" class="anchor" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E8%A7%A3%E9%87%8A" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>官方文档解释</h2>
<pre><code>ObjectId(&lt;hexadecimal&gt;)
</code></pre>
<p>返回一个新的 <a href="https://docs.mongodb.com/manual/reference/bson-types/#objectid" rel="nofollow">ObjectId</a> 值. 这个12字节（12-byte）的 <a href="https://docs.mongodb.com/manual/reference/bson-types/#objectid" rel="nofollow">ObjectId</a> 包括：</p>
<ul>
<li>4字节的unix秒级时间戳（即10位的时间戳）,</li>
<li>3字节的机器代码,</li>
<li>2字节的进程代码</li>
<li>3自己的计数器（从一个随机数开始）</li>
</ul>
<p>可选参数：</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hexadecimal</code></td>
<td>String</td>
<td>可选，16进制字符串</td>
</tr>
</tbody>
</table>
<pre><code>ObjectId() 有以下属性和方法:
</code></pre>
<table>
<thead>
<tr>
<th>Attribute/Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>str</td>
<td>返回这个id的16进制表示的字符串.</td>
</tr>
<tr>
<td>ObjectId.getTimestamp()</td>
<td>返回这个id编码的时间戳.</td>
</tr>
<tr>
<td>ObjectId.toString()</td>
<td>返回字符串： <code>ObjectId(...)</code>.</td>
</tr>
<tr>
<td>ObjectId.valueOf()</td>
<td>就是 属性 <code>str</code>返回的那个，一样的</td>
</tr>
</tbody>
</table>
<h1>
<a id="user-content-解释一个真实的id" class="anchor" href="#%E8%A7%A3%E9%87%8A%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84id" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>解释一个真实的id</h1>
<pre><code>596cee8fd68096396dc0390b
</code></pre>
<h2>
<a id="user-content-时间戳" class="anchor" href="#%E6%97%B6%E9%97%B4%E6%88%B3" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>时间戳</h2>
<p>一个秒级的时间戳是10位十进制数的，如果采用无符号表示方法，那么n位二进制（n个bit）可以表示的最大数字是 <code>2^n-1</code>，现在需要表示秒级时间戳，就需要m bit的空间，也就是：</p>
<pre><code>$$2^m - 1 &gt;= 10^9$$
$$m &gt;= log_{2}^(10^9 + 1)$$
$$m &gt;= 29.8974$$
</code></pre>
<p>不过注意哈，objectid是用16进制表示的，我们知道4位二进制对应于1位16进制，所以要么是8位（对应于32位二进制，满足 $$m &gt;= 29.8974$$），要么是7位16进制（对应于28位二进制，不满足$$m &gt;= 29.8974$$）
所以很显然，<strong>m取 32，也就是说用8位16进制字符串（32bit）表示一个时间戳</strong>
这个在定义中就明确了：<code>4字节的unix秒级时间戳</code>，即32bit</p>
<h2>
<a id="user-content-分割objectid" class="anchor" href="#%E5%88%86%E5%89%B2objectid" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>分割ObjectId</h2>
<pre><code>596cee8fd68096396dc0390b =&gt; 596cee8f  d68096  396d  c0390b
</code></pre>
<p><code>596cee8f</code>是16进制时间戳，转化为10进制： <code>sadf</code>
<code>d68096</code>是机器代码，不会变
<code>396d</code>是进程代码，不会变
<code>c0390b</code>是计数器，从随机数开始增加</p>
<h2>
<a id="user-content-创建objectid" class="anchor" href="#%E5%88%9B%E5%BB%BAobjectid" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>创建ObjectId</h2>
<p><a href="https://camo.githubusercontent.com/704b144a2b83577582bb35e7358debdac556f2e9/68747470733a2f2f7777772e64726f70626f782e636f6d2f732f707334366a336234773479683239762f45333534383234322d314136412d343141352d423846412d3231383636353231324334412e706e673f646c3d31" target="_blank" rel="nofollow"><img src="https://camo.githubusercontent.com/704b144a2b83577582bb35e7358debdac556f2e9/68747470733a2f2f7777772e64726f70626f782e636f6d2f732f707334366a336234773479683239762f45333534383234322d314136412d343141352d423846412d3231383636353231324334412e706e673f646c3d31" alt="" data-canonical-src="https://www.dropbox.com/s/ps46j3b4w4yh29v/E3548242-1A6A-41A5-B8FA-218665212C4A.png?dl=1" style="max-width:100%;"></a></p>
<p>可以看到，数据符合我们的预期，中间两个代码没有变，前面的增加的是秒数，后面的是计数器（+1）</p>
<h1>
<a id="user-content-引用" class="anchor" href="#%E5%BC%95%E7%94%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>引用</h1>
<ul>
<li>官方文档：<a href="https://docs.mongodb.com/manual/reference/method/ObjectId/" rel="nofollow">https://docs.mongodb.com/manual/reference/method/ObjectId/</a>
</li>
<li>latex写公式：<a href="http://jzqt.github.io/2015/06/30/Markdown%E4%B8%AD%E5%86%99%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F/" rel="nofollow">http://jzqt.github.io/2015/06/30/Markdown%E4%B8%AD%E5%86%99%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F/</a>
</li>
</ul>


</div>

</body>
</html>
