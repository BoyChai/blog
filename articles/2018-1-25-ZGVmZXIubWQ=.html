
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>defer.md - Chyroc的博客</title>
<meta property="og:title" content="blog.chyroc.cn" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Chyroc的博客" />
<meta property="og:description" content="Chyroc的博客" />
<link rel="canonical" href="blog.chyroc.cn" />
<meta property="og:url" content="blog.chyroc.cn" />
<meta property="og:site_name" content="blog.chyroc.cn" />
<script type="application/ld+json">
{"name":"blog.chyroc.cn","description":"Chyroc的博客","author":"Chyroc","@type":"WebSite","url":"blog.chyroc.cn","image":null,"publisher":null,"headline":"blog.chyroc.cn","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>


<link href="http://blog.chyroc.cn/assets/css/style.css" rel="stylesheet">
</head>
<body>
<div class="container-lg px-3 my-5 markdown-body">

<h1>
<a id="user-content-defer与panic的问题defer之二" class="anchor" href="#defer%E4%B8%8Epanic%E7%9A%84%E9%97%AE%E9%A2%98defer%E4%B9%8B%E4%BA%8C" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>defer与panic的问题（defer之二）</h1>
<ul>
<li>time 2018-01-25</li>
</ul>
<p>defer与panic问题</p>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">func</span> <span class="pl-en">f1</span>() {
	<span class="pl-k">defer</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>f1-begin<span class="pl-pds">"</span></span>)
	<span class="pl-c1">f2</span>()
	<span class="pl-k">defer</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>f1-end<span class="pl-pds">"</span></span>)
}

<span class="pl-k">func</span> <span class="pl-en">f2</span>() {
	<span class="pl-k">defer</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>f2-begin<span class="pl-pds">"</span></span>)
	<span class="pl-c1">f3</span>()
	<span class="pl-k">defer</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>f2-end<span class="pl-pds">"</span></span>)
}

<span class="pl-k">func</span> <span class="pl-en">f3</span>() {
	<span class="pl-k">defer</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>f3-begin<span class="pl-pds">"</span></span>)
	<span class="pl-c1">panic</span>(<span class="pl-c1">0</span>)
	<span class="pl-k">defer</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>f3-end<span class="pl-pds">"</span></span>)
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-c1">f1</span>()
}</pre></div>
<p>最后f3中panic，所以defer不再增加，defer栈是：<code>f11 f21 f31 panic</code></p>
<p>第二个问题</p>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> <span class="pl-s"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>

<span class="pl-k">func</span> <span class="pl-en">f</span>() {
	<span class="pl-k">defer</span> <span class="pl-k">func</span>() {
		<span class="pl-k">if</span> <span class="pl-smi">r</span> <span class="pl-k">:=</span> <span class="pl-c1">recover</span>(); r != <span class="pl-c1">nil</span> {
			log.<span class="pl-c1">Printf</span>(<span class="pl-s"><span class="pl-pds">"</span>recover:<span class="pl-c1">%#v</span><span class="pl-pds">"</span></span>, r)
		}
	}()
	<span class="pl-c1">panic</span>(<span class="pl-c1">1</span>)
	<span class="pl-c1">panic</span>(<span class="pl-c1">2</span>)
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-c1">f</span>()
}</pre></div>
<p>两个panic的时候recover，结果是什么：</p>
<p>panic之后，要么直接退出函数，要么recover一下退出函数，不会再执行别的代码</p>


</div>

</body>
</html>
